<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEEP DIVE MEETING PROGRESS UPDATE - SOUTH</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Custom Font Import if needed, using system fonts for speed */
        body { font-family: 'Inter', sans-serif; }
        .bg-undp-blue { background-color: #006EB5; }
        .text-undp-blue { color: #006EB5; }
        .bg-undp-light { background-color: #41B6E6; }
        .text-undp-light { color: #41B6E6; }
        .border-undp-blue { border-color: #006EB5; }
        
        /* Smooth transitions for bars */
        .progress-bar { transition: width 1s ease-out; }
    </style>
</head>
<body class="min-h-screen bg-[#020b1c] text-slate-200 selection:bg-[#006EB5]/30">

    <!-- Decorative Background -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-[#006EB5]/10 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-[#41B6E6]/10 rounded-full blur-[120px]"></div>
    </div>

    <div class="relative z-10 max-w-7xl mx-auto px-6 py-10">
        
        <!-- Header -->
        <header class="mb-12 flex flex-col md:flex-row md:items-start justify-between gap-6 border-b border-[#003366] pb-8 relative overflow-hidden">
            
            <div class="relative z-10 pt-4">
                <div class="flex items-center gap-2 mb-4">
                    <span id="last-updated-date" class="text-slate-400 text-xs font-semibold uppercase tracking-wider">Updated Dec 2025</span>
                </div>
                
                <!-- Project Title (Regular Font) -->
                <div class="text-xl md:text-2xl font-normal text-white mb-2">
                    UNDP Local Peacebuilding and Resilience Project
                </div>

                <!-- Dashboard Title (Bold/Large Font) -->
                <h1 class="text-4xl md:text-5xl font-bold text-white tracking-tight leading-tight">
                    <span class="text-[#006EB5]">South Region Activities Dashboard</span><br>
                    Deep Dive Meeting
                </h1>
            </div>

            <!-- Right Side cleared as requested -->
            
        </header>

        <!-- Key Metrics Title -->
        <h2 class="text-xl font-semibold text-white flex items-center gap-2 mb-6">
            <div class="w-1.5 h-6 bg-[#006EB5] rounded-full"></div>
            <span>Activities Overview</span>
        </h2>

        <!-- Key Metrics Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-12" id="stats-grid">
            <!-- Stats injected by JS -->
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-12">
            
            <!-- Status Distribution -->
            <div class="bg-[#002347]/40 border border-[#006EB5]/20 p-6 rounded-2xl backdrop-blur-md flex flex-col items-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-[#006EB5] to-[#41B6E6]"></div>
                <h3 class="text-slate-200 font-semibold mb-6 flex items-center gap-2 w-full">
                    <i data-lucide="pie-chart" class="w-4 h-4 text-[#41B6E6]"></i> Status Distribution
                </h3>
                <div class="flex items-center justify-between w-full px-4" id="status-chart-container">
                    <!-- Donut Chart -->
                </div>
            </div>

            <!-- Donor Allocation -->
            <div class="lg:col-span-2 bg-[#002347]/40 border border-[#006EB5]/20 p-6 rounded-2xl backdrop-blur-md flex flex-col relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-[#006EB5] to-[#41B6E6]"></div>
                <h3 class="text-slate-200 font-semibold mb-6 flex items-center gap-2">
                    <i data-lucide="activity" class="w-4 h-4 text-[#41B6E6]"></i> Donors 
                </h3>
                <div class="flex flex-col md:flex-row items-center justify-center h-full gap-8 md:gap-16">
                    <div class="shrink-0" id="donor-chart-container">
                        <!-- Donut Chart -->
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-12 gap-y-6 w-full max-w-md" id="donor-legend">
                        <!-- Legend Items -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Projects Section -->
        <div class="space-y-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <h2 class="text-xl font-semibold text-white flex items-center gap-2">
                    <div class="w-1.5 h-6 bg-[#006EB5] rounded-full"></div>
                    <!-- Updated Title to "Activities Cards" -->
                    <span id="projects-title">Activities Cards</span>
                </h2>
                <div class="flex gap-2">
                    <button onclick="setFilter('all')" id="btn-all" class="px-4 py-1.5 rounded-lg text-sm font-medium transition-colors bg-[#006EB5] text-white shadow-lg shadow-[#006EB5]/20">
                        All Projects
                    </button>
                    <button onclick="setFilter('delayed')" id="btn-delayed" class="px-4 py-1.5 rounded-lg text-sm font-medium transition-colors bg-[#002347] text-slate-400 border border-[#003366] hover:bg-[#003366]">
                        Delayed / Attention
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="projects-grid">
                <!-- Project Cards injected by JS -->
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-16 pt-8 border-t border-[#003366] flex flex-col md:flex-row justify-between items-center text-slate-500 text-sm gap-4">
            <div class="flex gap-6">
                <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-[#41B6E6]"></div><span>On Track</span></div>
                <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-amber-400"></div><span>Attention Required</span></div>
                <div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-rose-500"></div><span>Action Item</span></div>
            </div>
            <p>© 2025 United Nations Development Programme. Internal Use Only.</p>
        </div>

    </div>

    <!-- Application Logic -->
    <script>
        // --- Data ---
        const projects = [
            {
                id: 1, region: "South", donor: "PBF", activity: "Weather Station Equipment - Ubari and Ghat",
                percentage: 100, progressDesc: "(Delivered to LNMC. Training Dec 10th in Tripoli. )", comments: "Discussion on installation still ongoing with LNMC",
                icon: "cloud-rain",
                link: "https://drive.google.com/drive/folders/1AevU9U_AfhpfpZvNza55fMDvRU_pn879?usp=sharing",
                value: "USD 93,893.17"
            },
            {
                id: 2, region: "South", donor: "FW", activity: "Local Governance and Civic Participation Training",
                percentage: 100, progressDesc: "Completed 100%", status: "Finalized", comments: "",
                icon: "users",
                value: "USD 14,214.79",
                link: "https://drive.google.com/drive/folders/1GDMI0gGudwc3zuDwRdl5xfMQyxm4dsfC?usp=sharing"
            },
            {
                id: 3, region: "South", donor: "FW", activity: "Report: Governance Diagnostic Towards Transformative Local Action in Murzuq and Sebha",
                percentage: 100, progressDesc: "Completed 100%", status: "Finalized", comments: "Diagnostic Document Available",
                icon: "clipboard-check",
                link: "https://undp.sharepoint.com/teams/LBY/Shared%20Documents/Forms/AllItems.aspx?id=%2Fteams%2FLBY%2FShared%20Documents%2FPROGRAMME%2FStreghtening%20Local%20Capacity%20for%20Recovery%20and%20Resilience%20SLCRR%2F5%2E%20Communications%2FContent%20Materials%2FGovernance%20Diagnostic%20Towards%20Transformative%20Local%20Action%2Epdf&parent=%2Fteams%2FLBY%2FShared%20Documents%2FPROGRAMME%2FStreghtening%20Local%20Capacity%20for%20Recovery%20and%20Resilience%20SLCRR%2F5%2E%20Communications%2FContent%20Materials",
                value: "USD 21,000"
            },
            {
                id: 4, region: "South", donor: "FW", activity: "Rehabilitation of GIS office in Sebha municipality",
                percentage: 100, progressDesc: "Contracted - Site Handed over on 3 November", comments: "",
                icon: "building",
                value: "USD 42,800",
                link: "https://drive.google.com/drive/folders/1eU0gnOQxVMzm6L5rf7AQE5aPTtUefpdg?usp=sharing"
            },
            {
                id: 5, region: "South", donor: "FW", activity: "Procurement of GIS workstation for Sebha Municipality including Data-Collection Tablets",
                percentage: 70, progressDesc: "Contracted", comments: "delivery is planned for 18 March 2026, (this includes the 1-week buffer).",
                icon: "monitor",
                value: "USD 83,366"
            },
            {
                id: 6, region: "South", donor: "FW", activity: "Training & mentorship program on journalism ethics, and mobile content production in Sebha",
                percentage: 100, progressDesc: "Completed 100%", status: "Finalized", comments: "(20+) UNDP Libya Facebook",
                icon: "mic",
                link: "https://www.facebook.com/story.php?story_fbid=1260640969441461&id=100064867081184&mibextid=wwXIfr&rdid=nutuCBcD6xDk69J8",
                value: "USD 3,765"
            },
            {
                id: 7, region: "South", donor: "FW / Norway", activity: "Peacebuilding & Local Development Plans – Implementation Progress Tracking Application",
                percentage: 65, progressDesc: "Completion Date: before end of March", comments: "working on the Tracking Application",
                icon: "smartphone",
                value: "USD 22,000"
            },
            {
                id: 8, region: "South", donor: "FW", activity: "(Small Grants to Local Women’s Organizations)",
                percentage: 0, progressDesc: "Activity kick-off meeting – 15 February 2026", comments: "RPA Review Process Finalized",
                icon: "heart-handshake",
                value: "USD 75,000"
            },
            {
                id: 9, region: "South", donor: "Norway", activity: "Construction of Football Pitch in Bent Baya",
                percentage: 77, progressDesc: "Contracted - Handover site on 10th Nov", comments: "(Completion Date: 28 February 2026)",
                icon: "trophy",
                value: "USD 73,819",
                link: "https://drive.google.com/drive/folders/1EGtudcRWjh-Bv7CECnTeHet13csRXDBV?usp=drive_link"
            },
            {
                id: 10, region: "South", donor: "Norway", activity: "Rehabilitation and upgrade of the municipal community consultation hall in Gurda",
                percentage: 100, progressDesc: "Contracted - Handover site 11th Nov", comments: "(The initial handover process is under coordination)",
                icon: "home",
                value: "USD 48,581",
                link: "https://drive.google.com/drive/folders/11ll_TQ60y17iB3YyRUCcmtASyDlbLnf_?usp=sharing"
            },
            {
                id: 11, region: "South", donor: "Norway", activity: "Provision of Engineering Services for the Rehabilitation of Water Well in Muzque (Sharguiya)",
                percentage: 35, progressDesc: "extended to 18 April-2026", comments: "Tentative site handover to the contractor on 21 December 2025. The water well drilling rig has arrived at the site; however, due to a fuel shortage in the Muzque (Sharguiya), the contractor has formally requested NCE.",
                icon: "droplets",
                value: "USD 55,000",
                link: "https://drive.google.com/drive/folders/1K_C4pbe4pwAl-7y1DK_EiadwCaXcD0JU?usp=sharing"
            },
            {
                id: 12, region: "South", donor: "Norway", activity: "Capacity building for Local Peace and Development Committees in M&E and oversight",
                percentage: 0, progressDesc: "The consultant has been awarded and is currently conducting mapping stakeholders stage.", comments: "",
                icon: "book-open"
            },
            {
                id: 13, region: "South", donor: "AfDB", activity: "TOT training to municipal business incubators by team Libya, DERAYA project (Sebha)",
                percentage: 100, progressDesc: "Finalized", status: "Finalized", comments: "Deraya Activity Link",
                icon: "graduation-cap",
                link: "https://www.linkedin.com/posts/deraya_aezaewaffaepaex-aexaezaepaeyaer-team-activity-7391096873102528514-RdiP",
                value: "USD 15,000"
            },
            {
                id: 14, region: "South", donor: "AfDB", activity: "MSMEDA Study Tour",
                percentage: 0, progressDesc: "Aiming to have the tour in May", comments: "Since there was a delay in getting Security confirmation for the trip to Egypt, we have searched for alternative countries to conduct the tour. We have a confirmation from the bank to conduct the study tour in Morocco preparation has started aiming to have the tour in May",
                icon: "plane",
                link: "https://drive.google.com/drive/folders/1hysMrCd2mzwQo3IuPq_flffi7Ck-wNC_?usp=sharing"
            },
            {
                id: 15, region: "South", donor: "AfDB", activity: "Small Grants to Start Ups in Sebha",
                percentage: 55, progressDesc: "Implementation ongoing", comments: "(Completion Date: 31 May 2026)",
                icon: "rocket",
                value: "USD 87,582.047"
            },
            {
                id: 16, region: "South", donor: "FW / Italy", activity: "Supply of Electrical Materials for Murzuq Municipality, Libya – Receiving Entity: GECOL",
                percentage: 100, progressDesc: "The activity awarded on 14-dec 2025. (final hand over process", status: "Finalized", comments: "This activity covers electrical connection works in Murzuq Municipality, implemented through GECOL. The activity has been recently awarded, aiming to enhance electricity service delivery in the southern region.",
                icon: "zap",
                value: "USD 180,911.70",
                link: "https://drive.google.com/drive/folders/1z3fo-T-1br-MGdKF3itdPUrc03qf811T?usp=sharing"
            }
        ];

        // --- Helpers ---
        function createDonutChart(data, size = 160, thickness = 12) {
            const total = data.reduce((acc, item) => acc + item.value, 0);
            const radius = (size - thickness) / 2;
            const circumference = 2 * Math.PI * radius;
            let currentOffset = 0;

            let svgContent = data.map((item) => {
                const strokeDasharray = `${(item.value / total) * circumference} ${circumference}`;
                const strokeDashoffset = -currentOffset;
                currentOffset += (item.value / total) * circumference;

                return `<circle cx="${size/2}" cy="${size/2}" r="${radius}" fill="transparent" stroke="${item.color}" stroke-width="${thickness}" stroke-dasharray="${strokeDasharray}" stroke-dashoffset="${strokeDashoffset}" stroke-linecap="round" class="hover:opacity-80 transition-opacity duration-300" />`;
            }).join('');

            return `
                <div class="relative flex items-center justify-center" style="width: ${size}px; height: ${size}px;">
                    <svg width="${size}" height="${size}" class="transform -rotate-90">
                        ${svgContent}
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                        <span class="text-3xl font-bold text-white">${total}</span>
                        <span class="text-[10px] uppercase tracking-widest text-[#41B6E6]">Total</span>
                    </div>
                </div>
            `;
        }

        function createPieChart(data, size = 160, innerLabel = "Total", customTotal = null) {
            const total = data.reduce((acc, item) => acc + item.value, 0);
            let cumulativePercent = 0;
            const radius = size / 2;
            const displayTotal = customTotal !== null ? customTotal : total;
            
            // Handle single item case
            if (data.length === 1) {
                 return `
                    <div class="relative flex items-center justify-center" style="width: ${size}px; height: ${size}px;">
                        <svg width="${size}" height="${size}" class="transform -rotate-90">
                            <circle cx="${radius}" cy="${radius}" r="${radius}" fill="${data[0].color}" />
                        </svg>
                    </div>
                `;
            }

            const paths = data.map(slice => {
                const startPercent = cumulativePercent;
                const slicePercent = slice.value / total;
                const endPercent = cumulativePercent + slicePercent;
                
                // Calculate coordinates
                const x1 = Math.cos(2 * Math.PI * startPercent) * radius + radius;
                const y1 = Math.sin(2 * Math.PI * startPercent) * radius + radius;
                const x2 = Math.cos(2 * Math.PI * endPercent) * radius + radius;
                const y2 = Math.sin(2 * Math.PI * endPercent) * radius + radius;
                
                const largeArcFlag = slicePercent > 0.5 ? 1 : 0;
                
                const pathData = [
                    `M ${radius} ${radius}`,
                    `L ${x1} ${y1}`,
                    `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2}`,
                    `Z`
                ].join(' ');
                
                cumulativePercent += slicePercent;
                
                // Added stroke to separate slices
                return `<path d="${pathData}" fill="${slice.color}" stroke="#020b1c" stroke-width="2" class="hover:opacity-80 transition-opacity duration-300" />`;
            }).join('');

            return `
                <div class="relative flex items-center justify-center" style="width: ${size}px; height: ${size}px;">
                    <svg width="${size}" height="${size}" class="transform -rotate-90 drop-shadow-xl">
                        ${paths}
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-10">
                        <div class="bg-[#020b1c]/80 backdrop-blur-sm rounded-full w-20 h-20 flex flex-col items-center justify-center border border-[#006EB5]/30">
                            <span class="text-2xl font-bold text-white">${displayTotal}</span>
                            <span class="text-[9px] uppercase tracking-widest text-[#41B6E6]">${innerLabel}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function createProjectCard(project) {
            const commentsLower = project.comments?.toLowerCase() || "";
            const progressLower = project.progressDesc?.toLowerCase() || "";
            
            const isDelayed = commentsLower.includes('delay') || commentsLower.includes('stalled') || commentsLower.includes('awaiting') || progressLower.includes('stalled');
            const isActionRequired = project.comments.includes("FOLOW UP") || project.comments.includes("IS WITH IBRAHIM");
            
            // Status Badge
            let statusBadge = '';
            if (project.status === 'Finalized' || project.percentage === 100) {
                 statusBadge = `<span class="flex items-center gap-1 text-emerald-400 text-xs font-bold bg-emerald-500/10 px-2 py-1 rounded-full border border-emerald-500/20"><i data-lucide="check-circle-2" class="w-3 h-3"></i> Finalized</span>`;
            } else if (project.status === 'Stalled') {
                 statusBadge = `<span class="flex items-center gap-1 text-rose-400 text-xs font-bold bg-rose-500/10 px-2 py-1 rounded-full border border-rose-500/20"><i data-lucide="x-circle" class="w-3 h-3"></i> Stalled</span>`;
            } else if (project.status === 'Under Review') {
                 statusBadge = `<span class="flex items-center gap-1 text-amber-400 text-xs font-bold bg-amber-500/10 px-2 py-1 rounded-full border border-amber-500/20"><i data-lucide="file-search" class="w-3 h-3"></i> Under Review</span>`;
            } else if (project.status === 'Awarded') {
                 statusBadge = `<span class="flex items-center gap-1 text-purple-400 text-xs font-bold bg-purple-500/10 px-2 py-1 rounded-full border border-purple-500/20"><i data-lucide="award" class="w-3 h-3"></i> Awarded</span>`;
            } else {
                 statusBadge = `<span class="flex items-center gap-1 text-[#41B6E6] text-xs font-bold bg-[#006EB5]/10 px-2 py-1 rounded-full border border-[#006EB5]/20"><i data-lucide="clock" class="w-3 h-3"></i> On Going</span>`;
            }

            // Footer Logic
            let footerContent = '';
            if (isActionRequired) {
                footerContent = `
                    <div class="flex items-start gap-2 text-xs text-rose-300 bg-rose-900/10 p-2 rounded border border-rose-500/20">
                        <i data-lucide="alert-circle" class="w-3.5 h-3.5 shrink-0 mt-0.5"></i>
                        <span class="font-semibold">Action Required: ${project.comments}</span>
                    </div>`;
            } else if (isDelayed) {
                footerContent = `
                    <div class="flex items-start gap-2 text-xs text-amber-300 bg-amber-900/10 p-2 rounded border border-amber-500/20">
                        <i data-lucide="alert-triangle" class="w-3.5 h-3.5 shrink-0 mt-0.5"></i>
                        <span>${project.comments}</span>
                    </div>`;
            } else {
                footerContent = `
                    <div class="flex items-start gap-2 text-xs text-slate-400">
                        <i data-lucide="message-square" class="w-3.5 h-3.5 shrink-0 mt-0.5 text-[#006EB5]"></i>
                        <span>${project.comments || "No comments."}</span>
                    </div>`;
            }
            
            // Link Logic
            let linkContent = '';
            if (project.link) {
                linkContent = `
                    <a href="${project.link}" target="_blank" class="mt-3 flex items-center gap-1.5 text-xs font-bold text-[#41B6E6] hover:text-white transition-colors group/link w-fit">
                        View Resource <i data-lucide="arrow-up-right" class="w-3.5 h-3.5 transition-transform group-hover/link:-translate-y-0.5 group-hover/link:translate-x-0.5"></i>
                    </a>
                `;
            }

            // Progress Bar Logic
            let barColorClass = 'from-[#006EB5] to-[#41B6E6]';
            let textColorClass = 'text-[#41B6E6]';
            
            if (project.percentage === 100) {
                barColorClass = 'from-emerald-500 to-emerald-300';
                textColorClass = 'text-emerald-400';
            } else if (project.status === 'Stalled') {
                barColorClass = 'from-rose-500 to-rose-700';
                textColorClass = 'text-rose-400';
            }

            let customContent = '';
            
            // Check for Value/Budget Display (Supports 'value' prop or legacy string)
            let valueText = project.value;
            let isLegacyValue = false;

            if (!valueText && project.progressDesc && project.progressDesc.includes("Value:")) {
                 valueText = project.progressDesc.replace('Value:', '').trim();
                 isLegacyValue = true;
            }

            if (valueText) {
                 customContent = `
                    <div class="mb-4 relative bg-[#001a33] border border-[#003366] rounded-xl p-4 overflow-hidden group-hover:border-[#006EB5]/50 transition-colors">
                        <div class="relative z-10 flex items-center justify-between">
                            <div>
                                <p class="text-[10px] uppercase tracking-widest text-slate-400 font-semibold mb-1">Value</p>
                                <div class="text-2xl font-bold text-white tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-white to-[#41B6E6]">
                                    ${valueText}
                                </div>
                            </div>
                            <div class="h-10 w-10 rounded-full bg-[#006EB5]/20 flex items-center justify-center text-[#41B6E6] border border-[#006EB5]/30">
                                <i data-lucide="dollar-sign" class="w-5 h-5"></i>
                            </div>
                        </div>
                    </div>
                 `;
            }

            // Always show progress section, unless it was a legacy value-only card (to maintain compatibility if needed, though we updated data)
            // But we render description only if it's NOT the value string we just extracted
            const showDesc = project.percentage < 100 && !isLegacyValue;
            
            let progressSection = `
                <div>
                    <div class="flex justify-between text-xs mb-1.5">
                        <span class="text-slate-400 font-medium">Completion</span>
                        <span class="${textColorClass} font-bold">${project.percentage}%</span>
                    </div>
                    <div class="h-2 w-full bg-[#001a33] rounded-full overflow-hidden border border-[#003366]/50">
                        <div class="h-full bg-gradient-to-r ${barColorClass} rounded-full" style="width: ${project.percentage}%"></div>
                    </div>
                    ${showDesc ? `<p class="text-[10px] text-slate-500 mt-2">${project.progressDesc}</p>` : ''}
                </div>`;

            return `
                <div class="group relative overflow-hidden rounded-2xl bg-[#002347]/60 p-6 border border-[#006EB5]/30 backdrop-blur-xl shadow-xl transition-all duration-300 hover:scale-[1.02] hover:shadow-[#006EB5]/20 hover:border-[#006EB5]/80">
                    <div class="absolute -right-10 -top-10 h-32 w-32 rounded-full bg-[#006EB5]/10 blur-3xl group-hover:bg-[#006EB5]/20 transition-all duration-500"></div>
                    <div class="relative z-10 flex flex-col h-full justify-between">
                        <div>
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex items-center space-x-2">
                                    <span class="px-2.5 py-1 rounded-md text-xs font-bold bg-[#006EB5]/20 text-[#41B6E6] border border-[#006EB5]/30">${project.donor}</span>
                                    ${project.region ? `<span class="px-2 py-1 rounded-md text-xs font-medium text-slate-300 flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3"></i> ${project.region}</span>` : ''}
                                </div>
                                ${statusBadge}
                            </div>
                            <div class="flex items-start gap-3 mb-2">
                                <div class="p-2 rounded-lg bg-[#001a33] text-[#006EB5] border border-[#003366] shrink-0 mt-1">
                                    <i data-lucide="${project.icon}" class="w-5 h-5"></i>
                                </div>
                                <h3 class="text-sm md:text-base font-semibold text-white leading-snug">${project.activity}</h3>
                            </div>
                        </div>
                        <div class="mt-6 space-y-4">
                            ${customContent}
                            ${progressSection}
                            <div class="pt-4 border-t border-[#003366] min-h-[60px]">
                                ${footerContent}
                                ${linkContent}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createStatCard(title, value, subtext, icon, trend) {
            const trendClass = trend === 'up' ? 'from-[#006EB5]/20 to-[#41B6E6]/20 text-[#41B6E6]' : 'from-[#001a33] to-[#002347] text-slate-400';
            return `
                <div class="bg-[#002347]/40 border border-[#006EB5]/20 p-5 rounded-2xl backdrop-blur-md flex items-center justify-between shadow-lg">
                    <div>
                        <p class="text-slate-400 text-sm font-medium mb-1">${title}</p>
                        <h4 class="text-2xl font-bold text-white">${value}</h4>
                        <p class="text-xs text-[#41B6E6]/80 mt-1">${subtext}</p>
                    </div>
                    <div class="p-3 rounded-xl bg-gradient-to-br ${trendClass}">
                        <i data-lucide="${icon}" class="w-6 h-6"></i>
                    </div>
                </div>
            `;
        }

        // --- Main Logic ---
        let currentFilter = 'all';

        function renderStats() {
            const total = projects.length;
            const finalized = projects.filter(p => p.percentage === 100).length;
            
            // NEW Calculation: Average progress based on all cards
            const totalProgressSum = projects.reduce((acc, curr) => acc + curr.percentage, 0);
            const completionRate = Math.round(totalProgressSum / total);

            const grid = document.getElementById('stats-grid');
            
            // Custom Progress Card HTML
            const progressCard = `
                <div class="bg-[#002347]/40 border border-[#006EB5]/20 p-5 rounded-2xl backdrop-blur-md shadow-lg flex flex-col justify-center">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <p class="text-slate-400 text-sm font-medium mb-1">Average Progress</p>
                            <h4 class="text-2xl font-bold text-white">${completionRate}%</h4>
                        </div>
                        <div class="p-2 rounded-lg bg-[#006EB5]/10 text-[#41B6E6] border border-[#006EB5]/20">
                            <i data-lucide="trending-up" class="w-5 h-5"></i>
                        </div>
                    </div>
                    <div class="w-full">
                        <div class="flex justify-between text-xs mb-1.5">
                            <span class="text-slate-500">Overall Completion</span>
                            <span class="text-[#41B6E6] font-medium">${finalized}/${total} Activities Finalized</span>
                        </div>
                        <div class="h-2 w-full bg-[#001a33] rounded-full overflow-hidden border border-[#003366]/50">
                            <div class="h-full bg-gradient-to-r from-[#006EB5] to-[#41B6E6] rounded-full transition-all duration-1000" style="width: ${completionRate}%"></div>
                        </div>
                    </div>
                </div>
            `;

            grid.innerHTML = `
                ${createStatCard("Total Activities", total, "South Region", "layout-grid", "neutral")}
                ${progressCard}
                ${createStatCard("Ongoing Activities (including stalled)", total - finalized, "South Region", "clock", "neutral")}
            `;
        }

        function renderCharts() {
            // Status Data: Breakdown into Ongoing, Finalized, Stalled
            const finalized = projects.filter(p => p.status === 'Finalized' || p.percentage === 100).length;
            const stalled = projects.filter(p => p.status === 'Stalled').length;
            // Ongoing is Total minus (Finalized + Stalled)
            const ongoing = projects.length - finalized - stalled;

            const statusData = [
                { value: ongoing, color: '#41B6E6' },   // Light Blue
                { value: finalized, color: '#006EB5' }, // Dark Blue
                { value: stalled, color: '#f43f5e' }    // Red for Stalled
            ];
            
            // Render Status Chart & Legend
            const statusContainer = document.getElementById('status-chart-container');
            statusContainer.innerHTML = `
                ${createDonutChart(statusData)}
                <div class="space-y-3">
                    <div class="flex items-center gap-3 text-sm"><div class="w-3 h-3 rounded-full bg-[#41B6E6]"></div><span class="text-slate-400">Ongoing</span><span class="text-white font-bold">${ongoing}</span></div>
                    <div class="flex items-center gap-3 text-sm"><div class="w-3 h-3 rounded-full bg-[#006EB5]"></div><span class="text-slate-400">Finalized</span><span class="text-white font-bold">${finalized}</span></div>
                    <div class="flex items-center gap-3 text-sm"><div class="w-3 h-3 rounded-full bg-[#f43f5e]"></div><span class="text-slate-400">Stalled</span><span class="text-white font-bold">${stalled}</span></div>
                </div>
            `;

            // Donor Data - Explicit Logic per request
            // FW: 6, Norway: 4, FW / Norway: 1
            
            const donors = {};
            projects.forEach(p => {
                // Treated as single entity per user request (e.g. "FW / Norway" is one key)
                const name = p.donor.trim();
                donors[name] = (donors[name] || 0) + 1;
            });

            // Colors for the donors
            const colors = ['#006EB5', '#41B6E6', '#008CBA', '#6699CC', '#89CFF0', '#004d80'];
            
            const donorData = Object.keys(donors).map((name, index) => ({
                name: name,
                value: donors[name],
                color: colors[index % colors.length]
            })).sort((a, b) => b.value - a.value);

            // Render Donor Chart - Pie Chart with "Donors" label and dynamic value
            const chartHTML = createPieChart(donorData, 180, "Donors", donorData.length);
            
            document.getElementById('donor-chart-container').innerHTML = chartHTML;

            // Render Donor Legend
            document.getElementById('donor-legend').innerHTML = donorData.map(d => `
                <div class="flex items-center gap-4 group">
                    <div class="w-4 h-4 rounded-full shrink-0 shadow-[0_0_10px_rgba(0,0,0,0.3)]" style="background-color: ${d.color}"></div>
                    <div class="flex flex-col">
                        <span class="text-slate-400 text-sm font-medium group-hover:text-white transition-colors">${d.name}</span>
                        <div class="flex items-baseline gap-2">
                            <span class="text-2xl font-bold text-white">${d.value}</span>
                            <span class="text-xs text-slate-500 font-medium">Projects</span>
                        </div>
                    </div>
                </div>
            `).join('');

            // Small avatars REMOVED from header - no longer needed
        }

        function renderProjects() {
            const grid = document.getElementById('projects-grid');
            const title = document.getElementById('projects-title');
            
            let filtered = projects;
            if (currentFilter === 'delayed') {
                filtered = projects.filter(p => {
                    const commentsLower = p.comments?.toLowerCase() || "";
                    const progressLower = p.progressDesc?.toLowerCase() || "";
                    return commentsLower.includes('delay') || 
                           commentsLower.includes('challenge') || 
                           commentsLower.includes('awaiting') ||
                           commentsLower.includes('stalled') ||
                           progressLower.includes('stalled') ||
                           p.comments.includes("FOLOW UP") ||
                           p.comments.includes("IS WITH IBRAHIM");
                });
                title.innerText = 'Activities Cards (Attention Required)';
            } else {
                title.innerText = 'Activities Cards';
            }

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full py-12 text-center text-slate-500 bg-[#002347]/30 rounded-2xl border border-dashed border-[#003366]">
                        <p>No projects match this filter.</p>
                    </div>`;
            } else {
                grid.innerHTML = filtered.map(p => createProjectCard(p)).join('');
            }
            
            // Refresh icons after inserting new HTML
            lucide.createIcons();
        }

        function setFilter(type) {
            currentFilter = type;
            
            // Update UI buttons
            const btnAll = document.getElementById('btn-all');
            const btnDelayed = document.getElementById('btn-delayed');
            const activeClass = "bg-[#006EB5] text-white shadow-lg shadow-[#006EB5]/20";
            const inactiveClass = "bg-[#002347] text-slate-400 border border-[#003366] hover:bg-[#003366]";

            if (type === 'all') {
                btnAll.className = `px-4 py-1.5 rounded-lg text-sm font-medium transition-colors ${activeClass}`;
                btnDelayed.className = `px-4 py-1.5 rounded-lg text-sm font-medium transition-colors ${inactiveClass}`;
            } else {
                btnAll.className = `px-4 py-1.5 rounded-lg text-sm font-medium transition-colors ${inactiveClass}`;
                btnDelayed.className = `px-4 py-1.5 rounded-lg text-sm font-medium transition-colors ${activeClass}`;
            }

            renderProjects();
        }

        function updateDate() {
            const dateElement = document.getElementById('last-updated-date');
            if (dateElement) {
                const now = new Date();
                const options = { day: 'numeric', month: 'short', year: 'numeric' };
                const formattedDate = now.toLocaleDateString('en-GB', options);
                dateElement.innerText = `Updated ${formattedDate}`;
            }
        }

        // --- Init ---
        window.onload = () => {
            updateDate();
            renderStats();
            renderCharts();
            renderProjects();
            lucide.createIcons();
        };

    </script>
</body>
</html>